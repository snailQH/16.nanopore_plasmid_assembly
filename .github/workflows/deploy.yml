name: Deploy to Remote Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH
      run: |
        # Create .ssh directory with absolute path
        SSH_DIR="$HOME/.ssh"
        mkdir -p "$SSH_DIR"
        chmod 700 "$SSH_DIR"
        
        # Save SSH private key (preserve exact format, including newlines)
        # Use printf to ensure proper handling of newlines
        printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > "$SSH_DIR/deploy_key"
        chmod 600 "$SSH_DIR/deploy_key"
        
        # Verify key format
        echo "Checking SSH key format..."
        if ! ssh-keygen -l -f "$SSH_DIR/deploy_key" > /dev/null 2>&1; then
          echo "Error: Invalid SSH key format"
          echo "Key file first 100 characters:"
          head -c 100 "$SSH_DIR/deploy_key"
          exit 1
        fi
        echo "SSH key format is valid"
        
        # Add jump host and target host to known_hosts (disable strict checking for CI)
        ssh-keyscan -H 8.133.18.117 >> "$SSH_DIR/known_hosts" 2>/dev/null || true
        ssh-keyscan -p 2223 -H localhost >> "$SSH_DIR/known_hosts" 2>/dev/null || true
        
        # Create SSH config file with absolute path
        SSH_CONFIG="$SSH_DIR/config"
        cat > "$SSH_CONFIG" << 'EOF'
        Host jump-host
          HostName 8.133.18.117
          User root
          StrictHostKeyChecking no
          UserKnownHostsFile ~/.ssh/known_hosts
          IdentityFile ~/.ssh/deploy_key
          ForwardAgent yes
        
        Host target-server
          HostName localhost
          Port 2223
          User qinghuili
          ProxyJump jump-host
          StrictHostKeyChecking no
          UserKnownHostsFile ~/.ssh/known_hosts
          IdentityFile ~/.ssh/deploy_key
        EOF
        chmod 600 "$SSH_CONFIG"
        
        # Verify config file exists
        if [ ! -f "$SSH_CONFIG" ]; then
          echo "Error: SSH config file not created at $SSH_CONFIG"
          exit 1
        fi
        
        echo "SSH config file created at: $SSH_CONFIG"
        echo "SSH config contents:"
        cat "$SSH_CONFIG"
        
        # Test SSH connection (with verbose output for debugging)
        echo "Testing SSH connection to target server..."
        ssh -v -F "$SSH_CONFIG" target-server "echo 'SSH connection successful!'" || {
          echo "Warning: SSH connection test failed"
          echo "This may be due to jump host authentication. Continuing with deployment..."
        }
        
    - name: Deploy to remote server
      env:
        DEPLOY_PATH: /Users/qinghuili/AmpSeq/repository/16.nanopore_plasmid_assembly
        SSH_CONFIG: ${{ env.HOME }}/.ssh/config
      run: |
        SSH_CONFIG="$HOME/.ssh/config"
        
        # Verify SSH config exists
        if [ ! -f "$SSH_CONFIG" ]; then
          echo "Error: SSH config file not found at $SSH_CONFIG"
          exit 1
        fi
        
        echo "Creating deployment directory on remote server..."
        ssh -F "$SSH_CONFIG" target-server "mkdir -p $DEPLOY_PATH" || {
          echo "Error: Failed to create directory"
          exit 1
        }
        
        echo "Transferring files to remote server..."
        rsync -avz --delete \
          -e "ssh -F $SSH_CONFIG" \
          --exclude '.git' \
          --exclude '__pycache__' \
          --exclude '*.pyc' \
          --exclude '*.log' \
          --exclude 'output/' \
          --exclude 'results/' \
          --exclude '.nextflow/' \
          --exclude 'work/' \
          --exclude '*.fasta' \
          --exclude '*.fastq' \
          --exclude '*.ab1' \
          --exclude '*.pdf' \
          --exclude '*.csv' \
          --exclude '*.tsv' \
          --exclude '*.yaml' \
          --exclude 'config.yaml' \
          --exclude '.DS_Store' \
          --exclude '*.tmp' \
          --exclude '*.temp' \
          --exclude 'nanopore_plasmid_pipeline_v1.0.zip' \
          ./ target-server:$DEPLOY_PATH/ || {
          echo "Error: rsync failed"
          exit 1
        }
        
        echo "Setting permissions on remote server..."
        ssh -F "$SSH_CONFIG" target-server \
          "chmod +x $DEPLOY_PATH/run_pipeline.sh 2>/dev/null || true; \
           find $DEPLOY_PATH/scripts -type f -name '*.sh' -exec chmod +x {} \; 2>/dev/null || true; \
           echo 'Deployment completed successfully!'" || {
          echo "Warning: Permission setting failed, but deployment may have succeeded"
        }

