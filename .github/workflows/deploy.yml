name: Deploy to Remote Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Add jump host (8.133.18.117) to known_hosts
        ssh-keyscan -H 8.133.18.117 >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Add target host (localhost:2223) to known_hosts
        # Note: We need to scan through the jump host, but ssh-keyscan doesn't support ProxyJump
        # So we'll disable strict host key checking for this connection
        echo "Host 8.133.18.117" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile ~/.ssh/known_hosts" >> ~/.ssh/config
        echo "" >> ~/.ssh/config
        echo "Host target-server" >> ~/.ssh/config
        echo "  HostName localhost" >> ~/.ssh/config
        echo "  Port 2223" >> ~/.ssh/config
        echo "  User qinghuili" >> ~/.ssh/config
        echo "  ProxyJump root@8.133.18.117" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config
        echo "  UserKnownHostsFile ~/.ssh/known_hosts" >> ~/.ssh/config
        echo "  IdentityFile ~/.ssh/deploy_key" >> ~/.ssh/config
        chmod 600 ~/.ssh/config
        
    - name: Deploy to remote server
      env:
        DEPLOY_PATH: /Users/qinghuili/AmpSeq/repository/16.nanopore_plasmid_assembly
      run: |
        echo "Testing SSH connection..."
        ssh -F ~/.ssh/config target-server "echo 'SSH connection successful!'" || {
          echo "SSH connection test failed, but continuing..."
        }
        
        echo "Creating deployment directory on remote server..."
        ssh -F ~/.ssh/config target-server "mkdir -p $DEPLOY_PATH" || {
          echo "Failed to create directory, but continuing..."
        }
        
        echo "Transferring files to remote server..."
        rsync -avz --delete \
          -e "ssh -F ~/.ssh/config" \
          --exclude '.git' \
          --exclude '__pycache__' \
          --exclude '*.pyc' \
          --exclude '*.log' \
          --exclude 'output/' \
          --exclude 'results/' \
          --exclude '.nextflow/' \
          --exclude 'work/' \
          --exclude '*.fasta' \
          --exclude '*.fastq' \
          --exclude '*.ab1' \
          --exclude '*.pdf' \
          --exclude '*.csv' \
          --exclude '*.tsv' \
          --exclude '*.yaml' \
          --exclude 'config.yaml' \
          --exclude '.DS_Store' \
          --exclude '*.tmp' \
          --exclude '*.temp' \
          --exclude 'nanopore_plasmid_pipeline_v1.0.zip' \
          ./ target-server:$DEPLOY_PATH/
        
        echo "Setting permissions on remote server..."
        ssh -F ~/.ssh/config target-server \
          "chmod +x $DEPLOY_PATH/run_pipeline.sh 2>/dev/null || true; \
           find $DEPLOY_PATH/scripts -type f -name '*.sh' -exec chmod +x {} \; 2>/dev/null || true; \
           echo 'Deployment completed successfully!'"

