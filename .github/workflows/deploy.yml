name: Deploy to Remote Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup SSH
      run: |
        # Create .ssh directory with absolute path
        SSH_DIR="$HOME/.ssh"
        mkdir -p "$SSH_DIR"
        chmod 700 "$SSH_DIR"
        
        # Save SSH private key (preserve exact format, including newlines)
        # Use printf to ensure proper handling of newlines
        printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > "$SSH_DIR/deploy_key"
        chmod 600 "$SSH_DIR/deploy_key"
        
        # Verify key format
        echo "Checking SSH key format..."
        if ! ssh-keygen -l -f "$SSH_DIR/deploy_key" > /dev/null 2>&1; then
          echo "Error: Invalid SSH key format"
          echo "Key file first 100 characters:"
          head -c 100 "$SSH_DIR/deploy_key"
          exit 1
        fi
        echo "SSH key format is valid"
        
        # Add jump host and target host to known_hosts (disable strict checking for CI)
        ssh-keyscan -H 8.133.18.117 >> "$SSH_DIR/known_hosts" 2>/dev/null || true
        ssh-keyscan -p 2223 -H localhost >> "$SSH_DIR/known_hosts" 2>/dev/null || true
        
        # Create SSH config file with absolute path
        SSH_CONFIG="$SSH_DIR/config"
        cat > "$SSH_CONFIG" << 'EOF'
        Host jump-host
          HostName 8.133.18.117
          User root
          StrictHostKeyChecking no
          UserKnownHostsFile ~/.ssh/known_hosts
          IdentityFile ~/.ssh/deploy_key
          ForwardAgent yes
        
        Host target-server
          HostName localhost
          Port 2223
          User qinghuili
          ProxyJump jump-host
          StrictHostKeyChecking no
          UserKnownHostsFile ~/.ssh/known_hosts
          IdentityFile ~/.ssh/deploy_key
        EOF
        chmod 600 "$SSH_CONFIG"
        
        # Verify config file exists
        if [ ! -f "$SSH_CONFIG" ]; then
          echo "Error: SSH config file not created at $SSH_CONFIG"
          exit 1
        fi
        
        echo "SSH config file created at: $SSH_CONFIG"
        echo "SSH config contents:"
        cat "$SSH_CONFIG"
        
        # Test SSH connection (with verbose output for debugging)
        echo "Testing SSH connection to target server..."
        ssh -v -F "$SSH_CONFIG" target-server "echo 'SSH connection successful!'" || {
          echo "Warning: SSH connection test failed"
          echo "This may be due to jump host authentication. Continuing with deployment..."
        }
        
    - name: Deploy to remote server via Git
      env:
        DEPLOY_PATH: /Users/qinghuili/AmpSeq/repository/16.nanopore_plasmid_assembly
        GIT_REPO_URL: git@github.com:snailQH/16.nanopore_plasmid_assembly.git
        GIT_BRANCH: main
      run: |
        SSH_CONFIG="$HOME/.ssh/config"
        
        # Verify SSH config exists
        if [ ! -f "$SSH_CONFIG" ]; then
          echo "Error: SSH config file not found at $SSH_CONFIG"
          exit 1
        fi
        
        echo "Checking remote server connection..."
        ssh -F "$SSH_CONFIG" target-server "whoami" || {
          echo "Error: Failed to connect to remote server"
          exit 1
        }
        
        echo "Ensuring deployment directory exists..."
        # Create parent directory if it doesn't exist, but don't remove existing directory
        ssh -F "$SSH_CONFIG" target-server "mkdir -p $(dirname $DEPLOY_PATH)" || {
          echo "Error: Failed to create parent directory"
          exit 1
        }
        
        echo "Checking if deployment directory exists and is a git repository..."
        IS_GIT_REPO=$(ssh -F "$SSH_CONFIG" target-server "test -d $DEPLOY_PATH && cd $DEPLOY_PATH && git rev-parse --is-inside-work-tree 2>/dev/null && echo 'yes' || echo 'no'")
        
        if [ "$IS_GIT_REPO" = "yes" ]; then
          echo "Git repository found. Pulling latest changes..."
          ssh -F "$SSH_CONFIG" target-server \
            "cd $DEPLOY_PATH && \
             git fetch origin && \
             git checkout $GIT_BRANCH 2>/dev/null || git checkout -b $GIT_BRANCH origin/$GIT_BRANCH && \
             git pull origin $GIT_BRANCH" || {
            echo "Error: git pull failed, trying reset..."
            ssh -F "$SSH_CONFIG" target-server \
              "cd $DEPLOY_PATH && \
               git fetch origin && \
               git reset --hard origin/$GIT_BRANCH" || {
              echo "Error: git reset failed"
              exit 1
            }
          }
          echo "✓ Successfully pulled latest changes"
        else
          DEPLOY_DIR_EXISTS=$(ssh -F "$SSH_CONFIG" target-server "test -d $DEPLOY_PATH && echo 'yes' || echo 'no'")
          if [ "$DEPLOY_DIR_EXISTS" = "yes" ]; then
            echo "Directory exists but is not a git repository. Initializing git..."
            ssh -F "$SSH_CONFIG" target-server \
              "cd $DEPLOY_PATH && \
               git init && \
               git remote add origin $GIT_REPO_URL 2>/dev/null || git remote set-url origin $GIT_REPO_URL && \
               git fetch origin && \
               git checkout -b $GIT_BRANCH origin/$GIT_BRANCH 2>/dev/null || git reset --hard origin/$GIT_BRANCH" || {
              echo "Error: Failed to initialize git repository in existing directory"
              exit 1
            }
            echo "✓ Successfully initialized git repository"
          else
            echo "Directory does not exist. Cloning repository..."
            ssh -F "$SSH_CONFIG" target-server \
              "mkdir -p $DEPLOY_PATH && \
               git clone -b $GIT_BRANCH $GIT_REPO_URL $DEPLOY_PATH" || {
              echo "Error: git clone failed"
              exit 1
            }
            echo "✓ Successfully cloned repository"
          fi
        fi
        
        echo "Setting permissions on remote server..."
        ssh -F "$SSH_CONFIG" target-server \
          "chmod +x $DEPLOY_PATH/run_pipeline.sh 2>/dev/null || true; \
           find $DEPLOY_PATH/scripts -type f -name '*.sh' -exec chmod +x {} \; 2>/dev/null || true; \
           echo 'Deployment completed successfully!'" || {
          echo "Warning: Permission setting failed, but deployment may have succeeded"
        }
        
        echo "Verifying deployment..."
        COMMIT_HASH=$(git rev-parse HEAD)
        REMOTE_COMMIT=$(ssh -F "$SSH_CONFIG" target-server "cd $DEPLOY_PATH && git rev-parse HEAD")
        
        if [ "$COMMIT_HASH" = "$REMOTE_COMMIT" ]; then
          echo "✓ Deployment verified: Remote commit matches local commit ($COMMIT_HASH)"
        else
          echo "⚠ Warning: Remote commit ($REMOTE_COMMIT) differs from local commit ($COMMIT_HASH)"
        fi

